# 智能售后检测功能

## 功能说明

为代理机器人 `agent.py` 添加智能售后检测功能，在用户购买账号后自动检测账号质量。

## 检测方式

连接代理 → 登录账户 → 访问 @SpamBot → 获取回复 → 多语言关键词匹配判断状态

## 检测结果（4种）

| 结果 | 说明 | 处理 | 退款 |
|------|------|------|------|
| ✅ 正常 | 存活可用 | 打包到 `正常账号.zip` 发给用户 | ❌ 不退 |
| ❌ 封禁 | 封禁/注销/Session失效 | 发到坏号群 + 删除 | ✅ 单价 × 数量 |
| ⚠️ 冻结 | 账号被限制 | 发到坏号群 + 删除 | ✅ 单价 × 数量 |
| ❓ 未知错误 | 连接失败等 | 打包到 `未知错误账号.zip` 发给用户 | ❌ 不退，提示联系客服 |

## 配置

### 环境变量（.env）

```env
# API 配置（用于账号检测）
API_ID=2040
API_HASH=b18441a1ff607e10a989891a5462e627

# 坏号通知群组
BAD_ACCOUNT_GROUP_ID=-100xxxxxxxxxx

# Session 目录
BASE_PROTOCOL_PATH=/www/haopubot/haopu-main/协议号
FALLBACK_PROTOCOL_PATH=./协议号

# 是否启用检测（默认为true）
ENABLE_ACCOUNT_DETECTION=true
```

### 代理文件

在 `agent/` 目录下创建 `proxy.txt` 文件，支持所有格式：

```txt
socks5://127.0.0.1:1080
socks5://user:pass@127.0.0.1:1080
socks4://127.0.0.1:1080
http://127.0.0.1:8080
http://user:pass@127.0.0.1:8080
127.0.0.1:1080
127.0.0.1:1080:user:pass
```

参考 `proxy.txt.example` 文件配置。

## Session 文件结构

```
/www/haopubot/haopu-main/协议号/
├── {nowuid}/
│   ├── +8613800001.session
│   ├── +8613800001.json
│   ├── +8613800002.session
│   ├── +8613800002.json
│   └── ...
```

## 并发检测

- **30 线程并发**检测
- 代理连接失败自动更换代理
- 所有代理失败退回本地直连
- 检测间隔 5 秒

## 实时进度显示

```
🔍 正在检测账号质量... 

━━━━━━━━━━━━━━━━━━━━
📊 检测进度: 45/100

✅ 正常: 30
❌ 封禁: 10
⚠️ 冻结: 3
❓ 未知: 2

⏳ 检测中...
━━━━━━━━━━━━━━━━━━━━
```

## 检测完成消息

```
🛒 购买成功！

━━━━━━━━━━━━━━━━━━━━
📦 商品: Telegram 账号
💰 单价: 1 USDT
📊 购买数量: 10 个
━━━━━━━━━━━━━━━━━━━━

🔍 检测结果: 
✅ 正常: 7 个
❌ 封禁: 2 个
⚠️ 冻结: 1 个

💰 实付: 7 USDT
💵 退回: 3 USDT ✅

📁 正常账号已发送 ↓
[正常账号.zip]

━━━━━━━━━━━━━━━━━━━━
⚠️ 以下账号检测异常，请联系客服处理: 

❓ 未知错误: 2 个
[未知错误账号.zip]
━━━━━━━━━━━━━━━━━━━━
```

## 退款计算

```
退款金额 = (封禁数量 + 冻结数量) × 商品单价
```

退款自动返还到用户余额。

## 多语言关键词匹配

SpamBot 可能回复不同语言，使用多语言关键词匹配判断：

### ✅ 正常
- 英文: `good news`, `no limits`, `no restrictions`
- 中文: `好消息`, `没有限制`, `没有任何限制`
- 俄文: `хорошие новости`, `ограничений нет`, `нет ограничений`
- 波斯文: `خبر خوب`, `بدون محدودیت`
- 西班牙文: `buenas noticias`, `sin límites`
- 法文: `bonne nouvelle`, `aucune limite`

### ❌ 封禁（永久）
- 英文: `permanently limited`, `permanently restricted`
- 中文: `永久限制`, `永久受限`
- 俄文: `навсегда ограничен`
- 波斯文: `محدودیت دائمی`

### ⚠️ 冻结（临时限制）
- 英文: `limited`, `restricted`, `temporarily`
- 中文: `限制`, `受限`, `暂时`
- 俄文: `ограничен`, `временно`
- 波斯文: `محدود`, `موقت`
- 西班牙文: `limitado`, `restringido`
- 法文: `limité`, `restreint`

## 文件发送

- 正常账号 → `正常账号.zip` 发给用户
- 未知错误账号 → `未知错误账号.zip` 发给用户
- 封禁/冻结账号 → 发送到坏号群组（session + json 文件）

## 安装依赖

```bash
pip install -r requirements.txt
```

新增依赖：
- `Telethon>=1.24.0` - Telegram客户端库（用于账号登录和SpamBot检测）

## 使用说明

1. 配置环境变量（.env 文件）
2. 配置代理文件（proxy.txt）
3. 确保 Session 文件目录存在
4. 启动 agent bot

检测功能会在用户购买协议号类型商品时自动触发。

## 禁用检测

如需禁用检测功能，在 `.env` 文件中设置：

```env
ENABLE_ACCOUNT_DETECTION=false
```

或者删除/注释掉 `API_ID` 和 `API_HASH` 配置。

## 故障回退

如果检测系统不可用（缺少配置或检测失败），系统会自动回退到普通发货模式，不影响正常业务。

## 技术架构

- `account_detector.py` - 账号检测核心模块
  - `ProxyManager` - 代理管理器
  - `AccountDetector` - 单账号检测器
  - `BatchDetector` - 批量并发检测器
- `agent.py` - Bot主程序
  - `send_account_files_with_detection()` - 带检测的发货函数
  - `confirm_buy_product()` - 购买确认处理（集成检测）

## 日志

检测过程会记录详细日志到 `logs/agent_bot.log`：
- 代理加载和切换
- 账号检测进度
- 检测结果和错误信息
- 退款处理记录
